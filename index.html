<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Fraud Triage V1</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <py-config>
        packages = ["pandas"]
    </py-config>

    <style>
        body { font-family: -apple-system, system-ui, sans-serif; padding: 40px; background: #f6f8fa; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; border: 1px solid #d0d7de; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .badge-hold { background: #ffeef0; color: #cf222e; }
        .badge-review { background: #fff8c5; color: #9a6700; }
        .badge-pay { background: #dafbe1; color: #1a7f37; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; background: #f6f8fa; padding: 12px; border-bottom: 2px solid #d0d7de; }
        td { padding: 12px; border-bottom: 1px solid #d0d7de; }
    </style>
</head>
<body>

<div class="container">
    <h1>Affiliate Triage Agent <span style="color: #6e7781; font-weight: 200;">v1.0</span></h1>
    <div id="loading-msg">Status: Loading Python & Pandas (this may take 10 seconds)...</div>
    <div id="table-area"></div>

    <script type="py">
        import pandas as pd
        from datetime import datetime
        from pyscript import display, document

        # Test Data
        data = [
            ['TXN_1001', 'AFF_888', '2026-02-02 10:00:00', '2026-02-02 10:05:00', '45.12.19.101', 'US', 'US', 'Active'],
            ['TXN_1004', 'AFF_666', '2026-02-02 11:00:01', '2026-02-02 11:00:03', '192.168.0.1', 'US', 'US', 'Active'],
            ['TXN_1009', 'AFF_999', '2026-02-02 12:05:00', '2026-02-02 12:09:00', '99.12.33.11', 'US', 'US', 'Chargeback'],
            ['TXN_1013', 'AFF_777', '2026-02-02 13:00:00', '2026-02-02 13:05:00', '14.161.5.10', 'VN', 'US', 'Active']
        ]
        df = pd.DataFrame(data, columns=['txn_id', 'aff_id', 'click_time', 'post_time', 'ip', 'geo_ip', 'billing_country', 'crm_status'])

        def process_triage():
            rows_html = ""
            for idx, row in df.iterrows():
                score = 0
                reasons = []
                
                # Logic: Velocity
                fmt = '%Y-%m-%d %H:%M:%S'
                dt = (datetime.strptime(row['post_time'], fmt) - datetime.strptime(row['click_time'], fmt)).total_seconds()
                if dt < 15:
                    score += 50
                    reasons.append(f"Fast Velocity ({int(dt)}s)")
                
                # Logic: CRM Status
                if row['crm_status'] == 'Chargeback':
                    score += 100
                    reasons.append("Chargeback")

                # Logic: Geo
                if row['geo_ip'] != row['billing_country']:
                    score += 25
                    reasons.append("Geo Mismatch")

                decision = "HOLD" if score >= 60 else "REVIEW" if score >= 30 else "PAY"
                badge = f'<span class="badge badge-{decision.lower()}">{decision}</span>'
                
                rows_html += f"<tr><td>{row['txn_id']}</td><td>{score}</td><td>{badge}</td><td>{', '.join(reasons) if reasons else 'Clean'}</td></tr>"
            
            return rows_html

        # Generate Table
        html_out = f"""
        <table>
            <thead><tr><th>TXN ID</th><th>Score</th><th>Decision</th><th>Evidence</th></tr></thead>
            <tbody>{process_triage()}</tbody>
        </table>
        """
        
        document.getElementById("loading-msg").style.display = "none"
        document.getElementById("
