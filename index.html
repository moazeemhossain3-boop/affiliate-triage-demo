<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Fraud Triage V1</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <py-config>
        packages = ["pandas"]
    </py-config>

    <style>
        body { font-family: -apple-system, system-ui, sans-serif; padding: 40px; background: #f6f8fa; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; border: 1px solid #d0d7de; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .badge-hold { background: #ffeef0; color: #cf222e; }
        .badge-review { background: #fff8c5; color: #9a6700; }
        .badge-pay { background: #dafbe1; color: #1a7f37; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; background: #f6f8fa; padding: 12px; border-bottom: 2px solid #d0d7de; }
        td { padding: 12px; border-bottom: 1px solid #d0d7de; }
    </style>
</head>
<body>

<div class="container">
    <h1>Affiliate Triage Agent <span style="color: #6e7781; font-weight: 200;">v1.0</span></h1>
    <div id="status">Status: Loading Python & Pandas (this may take 10 seconds)...</div>
    <div id="results"></div>

    <script type="py">
        import pandas as pd
        from datetime import datetime
        from pyscript import document

        # 1. Setup Data
        data = [
            ['TXN_1001', 'AFF_888', '2026-02-02 10:00:00', '2026-02-02 10:05:00', '45.12.19.101', 'US', 'US', 'Active'],
            ['TXN_1004', 'AFF_666', '2026-02-02 11:00:01', '2026-02-02 11:00:03', '192.168.0.1', 'US', 'US', 'Active'],
            ['TXN_1009', 'AFF_999', '2026-02-02 12:05:00', '2026-02-02 12:09:00', '99.12.33.11', 'US', 'US', 'Chargeback'],
            ['TXN_1013', 'AFF_777', '2026-02-02 13:00:00', '2026-02-02 13:05:00', '14.161.5.10', 'VN', 'US', 'Active']
        ]
        df = pd.DataFrame(data, columns=['txn_id', 'aff_id', 'click_time', 'post_time', 'ip', 'geo_ip', 'billing_country', 'crm_status'])

        # 2. Logic Function
        def get_decision(row):
            score = 0
            reasons = []
            
            # Velocity Check
            fmt = '%Y-%m-%d %H:%M:%S'
            t1 = datetime.strptime(row['click_time'], fmt)
            t2 = datetime.strptime(row['post_time'], fmt)
            seconds = (t2 - t1).total_seconds()
            
            if seconds < 15:
                score += 50
                reasons.append(f"Fast Velocity ({int(seconds)}s)")
            
            # CRM Check
            if row['crm_status'] == 'Chargeback':
                score += 100
                reasons.append("Chargeback")
            
            # Geo Check
            if row['geo_ip'] != row['billing_country']:
                score += 25
                reasons.append("Geo Mismatch")

            # Final Triage
            decision = "PAY"
            if score >= 60:
                decision = "HOLD"
            elif score >= 30:
                decision = "REVIEW"
                
            return decision, score, reasons

        # 3. Build HTML Output
        # (Building this as a simple string to avoid SyntaxErrors)
        final_html = "<table><thead><tr><th>TXN ID</th><th>Score</th><th>Decision</th><th>Evidence</th></tr></thead><tbody>"

        for _, row in df.iterrows():
            decision, score, reasons = get_decision(row)
            
            # Create badge HTML
            badge_class = "badge badge-" + decision.lower()
            badge_html = f"<span class='{badge_class}'>{decision}</span>"
            
            # Create reason text
            reason_text = "Clean"
            if len(reasons) > 0:
                reason_text = ", ".join(reasons)

            # Add row
            final_html += f"<tr><td>{row['txn_id']}</td><td>{score}</td><td>{badge_html}</td><td>{reason_text}</td></tr>"

        final_html += "</tbody></table>"

        # 4. Update the Page
        # We target the IDs exactly as defined in the HTML above
        status_div = document.getElementById("status")
        status_div.style.display = "none"
        
        results_div = document.getElementById("results")
        results_div.innerHTML = final_html
    </script>
</div>
</body>
</html>
