<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Fraud Triage V1</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <py-config>
        packages = ["pandas"]
    </py-config>

    <style>
        body { font-family: -apple-system, system-ui, sans-serif; padding: 40px; background: #f6f8fa; color: #24292f; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 8px; border: 1px solid #d0d7de; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { border-bottom: 1px solid #d0d7de; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* Badges */
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-hold { background: #ffeef0; color: #cf222e; border: 1px solid #fdaeb7; }
        .badge-review { background: #fff8c5; color: #9a6700; border: 1px solid #d4a72c; }
        .badge-pay { background: #dafbe1; color: #1a7f37; border: 1px solid #4ac26b; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; background: #f6f8fa; padding: 12px; border-bottom: 2px solid #d0d7de; font-size: 13px; color: #57606a; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        
        /* Narrative Text Styling */
        .narrative { font-size: 13px; line-height: 1.5; color: #424a53; }
        .narrative strong { color: #cf222e; } /* Highlight bad things in red */
    </style>
</head>
<body>

<div class="container">
    <h1>Affiliate Triage Agent <span style="color: #6e7781; font-weight: 200;">v1.1</span></h1>
    <div id="status"><strong>System Status:</strong> Loading Logic Engine...</div>
    <div id="results"></div>

    <script type="py">
        import pandas as pd
        from datetime import datetime
        from pyscript import document

        # 1. Test Data
        data = [
            ['TXN_1001', 'AFF_888', '2026-02-02 10:00:00', '2026-02-02 10:05:00', '45.12.19.101', 'US', 'US', 'Active'],
            ['TXN_1004', 'AFF_666', '2026-02-02 11:00:01', '2026-02-02 11:00:03', '192.168.0.1', 'US', 'US', 'Active'],
            ['TXN_1009', 'AFF_999', '2026-02-02 12:05:00', '2026-02-02 12:09:00', '99.12.33.11', 'US', 'US', 'Chargeback'],
            ['TXN_1013', 'AFF_777', '2026-02-02 13:00:00', '2026-02-02 13:05:00', '14.161.5.10', 'VN', 'US', 'Active'],
            ['TXN_1016', 'AFF_222', '2026-02-02 14:00:00', '2026-02-02 14:00:01', '88.12.11.01', 'DE', 'DE', 'Active']
        ]
        columns = ['txn_id', 'aff_id', 'click_time', 'post_time', 'ip', 'geo_ip', 'billing_country', 'crm_status']
        df = pd.DataFrame(data, columns=columns)

        # 2. Analysis & Narrative Logic
        def analyze_transaction(row):
            score = 0
            flags = []
            
            # --- SIGNAL 1: VELOCITY ---
            fmt = '%Y-%m-%d %H:%M:%S'
            t1 = datetime.strptime(row['click_time'], fmt)
            t2 = datetime.strptime(row['post_time'], fmt)
            seconds = (t2 - t1).total_seconds()
            
            if seconds < 15:
                score += 50
                flags.append(f"inhuman speed ({int(seconds)}s)")

            # --- SIGNAL 2: CRM STATUS ---
            if row['crm_status'] == 'Chargeback':
                score += 100
                flags.append("financial fraud (chargeback)")
            elif row['crm_status'] == 'Refunded':
                score += 50
                flags.append("a refund request")

            # --- SIGNAL 3: GEO ---
            if row['geo_ip'] != row['billing_country']:
                score += 25
                flags.append(f"location mismatch ({row['geo_ip']} vs {row['billing_country']})")

            # --- DECISION ---
            decision = "PAY"
            if score >= 60:
                decision = "HOLD"
            elif score >= 30:
                decision = "REVIEW"

            # --- GENERATE PLAIN ENGLISH NARRATIVE ---
            narrative = ""
            if decision == "PAY":
                narrative = "Verified safe. User behavior, location, and payment status match standard organic patterns."
            elif decision == "HOLD":
                # Join flags with commas
                reasons = ", ".join(flags)
                narrative = f"Blocked due to <strong>critical risk indicators</strong>. System detected {reasons}. Do not release funds."
            else: # REVIEW
                reasons = ", ".join(flags)
                narrative = f"Flagged for inspection. Transaction is valid but shows <strong>{reasons}</strong>. Verify user identity."

            return decision, score, narrative

        # 3. Build HTML Output
        final_html = """
        <table>
            <thead>
                <tr>
                    <th style="width: 15%">Transaction</th>
                    <th style="width: 10%">Score</th>
                    <th style="width: 10%">Decision</th>
                    <th>Agent Explanation (Plain English)</th>
                </tr>
            </thead>
            <tbody>
        """

        for _, row in df.iterrows():
            decision, score, explanation = analyze_transaction(row)
            
            badge_class = "badge badge-" + decision.lower()
            
            final_html += f"""
            <tr>
                <td><b>{row['txn_id']}</b><br><small style='color:#666'>{row['aff_id']}</small></td>
                <td>{score} / 100</td>
                <td><span class='{badge_class}'>{decision}</span></td>
                <td class='narrative'>{explanation}</td>
            </tr>
            """

        final_html += "</tbody></table>"

        # 4. Render
        document.getElementById("status").style.display = "none"
        document.getElementById("results").innerHTML = final_html
    </script>
</div>
</body>
</html>
