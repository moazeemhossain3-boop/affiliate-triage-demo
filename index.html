<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Fraud Triage Agent</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <py-config>
        packages = ["pandas"]
    </py-config>

    <style>
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --primary: #2563eb;
            --danger: #dc2626;
            --warning: #d97706;
            --success: #059669;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            padding: 20px; 
            line-height: 1.5;
        }

        .dashboard-container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        /* Header Area */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #111827; }
        .subtitle { font-size: 0.9rem; color: var(--text-muted); font-weight: 400; }

        /* Controls Card */
        .controls-card {
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-upload-btn {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        /* Modern Table Styling */
        .table-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-responsive {
            overflow-x: auto;
            width: 100%;
        }

        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        th { 
            background: #f9fafb; 
            text-align: left; 
            padding: 16px; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--text-muted); 
            border-bottom: 1px solid var(--border);
        }
        
        td { 
            padding: 16px; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.9rem; 
            vertical-align: middle;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fafb; transition: background 0.15s; }

        /* Typography & Badges */
        .txn-id { font-weight: 600; color: var(--text-main); }
        .aff-id { font-size: 0.8rem; color: var(--text-muted); }
        
        .score-val { font-weight: 700; }
        .score-high { color: var(--danger); }
        .score-med { color: var(--warning); }
        .score-low { color: var(--success); }

        .badge { 
            padding: 4px 10px; 
            border-radius: 99px; 
            font-size: 0.75rem; 
            font-weight: 700; 
            display: inline-block;
        }
        .badge-hold { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-review { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
        .badge-pay { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }

        .narrative { font-size: 0.85rem; color: #4b5563; max-width: 400px; }
        .narrative strong { color: var(--danger); font-weight: 600; }

        /* Action Button */
        .btn-action {
            background: white;
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-main);
            transition: all 0.2s;
        }
        .btn-action:hover { border-color: #9ca3af; background: #f3f4f6; }
        .btn-primary { color: var(--primary); border-color: #bfdbfe; background: #eff6ff; }
        .btn-primary:hover { background: #dbeafe; }
        .btn-disabled { opacity: 0.5; cursor: default; border: none; background: none; }

        /* Loading State */
        #loader { font-size: 0.9rem; color: var(--text-muted); font-style: italic; }
    </style>
    
    <script>
        // JavaScript hook for the mock button
        function openCase(id, score) {
            alert(`Opening JIRA Ticket for Transaction ${id}\nRisk Score: ${score}\n\nRedirecting to Ops Queue...`);
        }
    </script>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <div>
            <h1>Affiliate Fraud Triage <span class="subtitle">v1.2</span></h1>
        </div>
        <div id="loader">Initializing AI Agent...</div>
    </div>

    <div class="controls-card">
        <label style="font-weight: 600; font-size: 0.9rem;">Data Source:</label>
        <input type="file" id="csv-upload" accept=".csv" style="font-size: 0.9rem;">
        <span style="font-size: 0.8rem; color: var(--text-muted); margin-left: auto;">*Upload standard postback logs</span>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <div id="results-area">
                </div>
        </div>
    </div>
</div>

<script type="py">
import pandas as pd
from datetime import datetime
from pyscript import document, window
from pyodide.ffi import create_proxy
import io

# --- 1. CORE LOGIC ENGINE ---
def analyze_row(row):
    score = 0
    flags = []
    
    # Logic: Velocity
    # Try multiple formats just in case user uploads weird CSVs
    try:
        fmt = '%Y-%m-%d %H:%M:%S'
        t1 = pd.to_datetime(row['click_time'])
        t2 = pd.to_datetime(row['post_time'])
        seconds = (t2 - t1).total_seconds()
        if seconds < 15:
            score += 50
            flags.append(f"inhuman speed ({int(seconds)}s)")
    except:
        pass # Skip time check if formats fail

    # Logic: CRM Status
    if str(row['crm_status']).lower() in ['chargeback', 'cb']:
        score += 100
        flags.append("chargeback detected")
    elif str(row['crm_status']).lower() == 'refunded':
        score += 50
        flags.append("refund request")

    # Logic: Geo
    if str(row['geo_ip']) != str(row['billing_country']):
        score += 25
        flags.append("geo mismatch")

    # Decision
    decision = "PAY"
    if score >= 60: decision = "HOLD"
    elif score >= 30: decision = "REVIEW"

    # Narrative
    if decision == "PAY":
        narrative = "Verified safe. Patterns match organic traffic."
    else:
        reasons = ", ".join(flags)
        narrative = f"Flagged due to <strong>{reasons}</strong>."

    return decision, score, narrative

def render_table(df):
    html = """
    <table>
        <thead>
            <tr>
                <th width="20%">Transaction / Affiliate</th>
                <th width="10%">Score</th>
                <th width="10%">Status</th>
                <th width="40%">Agent Narrative</th>
                <th width="20%">Action</th>
            </tr>
        </thead>
        <tbody>
    """
    
    for _, row in df.iterrows():
        decision, score, text = analyze_row(row)
        
        # Styles
        badge_cls = f"badge badge-{decision.lower()}"
        score_cls = "score-high" if score > 60 else "score-med" if score > 30 else "score-low"
        
        # Action Button Logic
        if decision == "PAY":
            btn_html = "<button class='btn-action btn-disabled'>Auto-Paid</button>"
        else:
            # We call the JS function openCase() defined in <head>
            btn_html = f"<button class='btn-action btn-primary' onclick='openCase(\"{row['txn_id']}\", {score})'>Open Case</button>"

        html += f"""
        <tr>
            <td>
                <div class="txn-id">{row['txn_id']}</div>
                <div class="aff-id">{row['aff_id']}</div>
            </td>
            <td><span class="{score_cls}">{score}</span></td>
            <td><span class="{badge_cls}">{decision}</span></td>
            <td class="narrative">{text}</td>
            <td>{btn_html}</td>
        </tr>
        """
    
    html += "</tbody></table>"
    document.getElementById("results-area").innerHTML = html
    document.getElementById("loader").style.display = "none"

# --- 2. FILE UPLOAD HANDLER ---
async def process_upload(event):
    document.getElementById("loader").style.display = "block"
    document.getElementById("loader").innerText = "Processing uploaded file..."
    
    # Get the file from the event
    file_list = event.target.files
    first_file = file_list.item(0)
    
    # Read text content
    content = await first_file.text()
    
    # Parse CSV string into Pandas
    try:
        df = pd.read_csv(io.StringIO(content))
        # Normalize headers to lower case to be safe
        df.columns = [c.lower() for c in df.columns]
        render_table(df)
    except Exception as e:
        window.alert(f"Error parsing CSV: {str(e)}")
        document.getElementById("loader").innerText = "Error loading file."

# --- 3. INITIALIZATION ---

# Load Default Data on Start
default_data = [
    ['TXN_1001', 'AFF_888', '2026-02-02 10:00:00', '2026-02-02 10:05:00', '45.12.19.101', 'US', 'US', 'Active'],
    ['TXN_1004', 'AFF_666', '2026-02-02 11:00:01', '2026-02-02 11:00:03', '192.168.0.1', 'US', 'US', 'Active'],
    ['TXN_1009', 'AFF_999', '2026-02-02 12:05:00', '2026-02-02 12:09:00', '99.12.33.11', 'US', 'US', 'Chargeback'],
    ['TXN_1013', 'AFF_777', '2026-02-02 13:00:00', '2026-02-02 13:05:00', '14.161.5.10', 'VN', 'US', 'Active'],
]
df_default = pd.DataFrame(default_data, columns=['txn_id', 'aff_id', 'click_time', 'post_time', 'ip', 'geo_ip', 'billing_country', 'crm_status'])
render_table(df_default)

# Attach Upload Event Listener
upload_element = document.getElementById("csv-upload")
upload_proxy = create_proxy(process_upload)
upload_element.addEventListener("change", upload_proxy)

</script>
</body>
</html>
