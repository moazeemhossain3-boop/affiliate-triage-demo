<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Fraud Triage V1 - Demo</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; padding: 40px; background: #f6f8fa; color: #24292f; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 8px; border: 1px solid #d0d7de; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
        h1 { border-bottom: 1px solid #d0d7de; padding-bottom: 10px; margin-bottom: 20px; font-weight: 600; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge-hold { background: #ffeef0; color: #cf222e; }
        .badge-review { background: #fff8c5; color: #9a6700; }
        .badge-pay { background: #dafbe1; color: #1a7f37; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; background: #f6f8fa; padding: 12px; border-bottom: 2px solid #d0d7de; }
        td { padding: 12px; border-bottom: 1px solid #d0d7de; font-size: 14px; }
        #loading { font-style: italic; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h1>Affiliate Triage Agent <span style="color: #6e7781; font-weight: 200;">v1.0</span></h1>
    <p>This demo applies the <strong>"Big 7" Signals</strong> to a test batch of  casino affiliate conversions ($100 Deposit CPA).</p>
    
    <div id="loading">Initializing Python Brain...</div>
    <div id="output-table"></div>

    <script type="py">
        import pandas as pd
        from datetime import datetime
        from pyscript import display

        # 1. Mock Dataset (The same one we designed earlier)
        data = [
            ['TXN_1001', 'AFF_888', '2026-02-02 10:00:00', '2026-02-02 10:05:00', '45.12.19.101', 'US', 'US', 'Active'],
            ['TXN_1004', 'AFF_666', '2026-02-02 11:00:01', '2026-02-02 11:00:03', '192.168.0.1', 'US', 'US', 'Active'],
            ['TXN_1009', 'AFF_999', '2026-02-02 12:05:00', '2026-02-02 12:09:00', '99.12.33.11', 'US', 'US', 'Chargeback'],
            ['TXN_1013', 'AFF_777', '2026-02-02 13:00:00', '2026-02-02 13:05:00', '14.161.5.10', 'VN', 'US', 'Active'],
            ['TXN_1016', 'AFF_222', '2026-02-02 14:00:00', '2026-02-02 14:00:01', '88.12.11.01', 'DE', 'DE', 'Active']
        ]
        columns = ['txn_id', 'aff_id', 'click_time', 'post_time', 'ip', 'geo_ip', 'billing_country', 'crm_status']
        df = pd.DataFrame(data, columns=columns)

        # 2. Scoring Logic
        def score_row(row):
            score = 0
            reasons = []
            fmt = '%Y-%m-%d %H:%M:%S'
            duration = (datetime.strptime(row['post_time'], fmt) - datetime.strptime(row['click_time'], fmt)).total_seconds()
            
            if duration < 15:
                score += 50
                reasons.append(f"Velocity: {int(duration)}s")
            if row['crm_status'] == 'Chargeback':
                score += 100
                reasons.append("Chargeback Reported")
            if row['geo_ip'] != row['billing_country']:
                score += 25
                reasons.append(f"Geo mismatch ({row['geo_ip']} vs {row['billing_country']})")
            
            decision = "HOLD" if score >= 60 else "REVIEW" if score >= 30 else "PAY"
            badge_class = f"badge badge-{decision.lower()}"
            
            # Formatting as HTML rows
            return f"""
                <tr>
                    <td><b>{row['txn_id']}</b><br><small>{row['aff_id']}</small></td>
                    <td>{score}</td>
                    <td><span class="{badge_class}">{decision}</span></td>
                    <td>{'; '.join(reasons) if reasons else 'Clean Traffic'}</td>
                </tr>
            """

        # 3. Render Table
        table_html = "<table><thead><tr><th>TXN / Affiliate</th><th>Risk Score</th><th>Decision</th><th>Evidence Summary</th></tr></thead><tbody>"
        for _, row in df.iterrows():
            table_html += score_row(row)
        table_html += "</tbody></table>"

        document.getElementById("loading").style.display = "none"
        document.getElementById("output-table").innerHTML = table_html
    </script>
</div>

</body>
</html>